---
- name: ğŸš€ Deploy LeadFlow na Servla
  hosts: servla_servers
  become: yes
  vars:
    app_name: leadflow
    app_user: www-data
    app_dir: /var/www/leadflow
    node_version: "18"
    
  tasks:
    - name: ğŸ“‹ Atualizar cache de pacotes
      apt:
        update_cache: yes
        cache_valid_time: 3600
        
    - name: ğŸ“¦ Instalar dependÃªncias do sistema
      apt:
        name:
          - curl
          - wget
          - git
          - unzip
          - software-properties-common
          - nginx
          - ufw
          - certbot
          - python3-certbot-nginx
        state: present
        
    - name: ğŸŸ¢ Instalar Node.js {{ node_version }}
      block:
        - name: Adicionar repositÃ³rio NodeSource
          shell: curl -fsSL https://deb.nodesource.com/setup_{{ node_version }}.x | sudo -E bash -
          
        - name: Instalar Node.js
          apt:
            name: nodejs
            state: present
            
    - name: ğŸ“¦ Instalar PM2 globalmente
      npm:
        name: pm2
        global: yes
        
    - name: ğŸ”§ Configurar firewall
      ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop:
        - "22"
        - "80"
        - "443"
        
    - name: ğŸ”§ Habilitar firewall
      ufw:
        state: enabled
        
    - name: ğŸ“ Criar diretÃ³rio da aplicaÃ§Ã£o
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'
        
    - name: ğŸ“¥ Clonar repositÃ³rio
      git:
        repo: https://github.com/mindflowai1/leadflow.git
        dest: "{{ app_dir }}"
        version: main
        force: yes
        
    - name: ğŸ“‹ Copiar arquivo de variÃ¡veis de ambiente
      copy:
        src: env.example
        dest: "{{ app_dir }}/.env"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0644'
        
    - name: ğŸ“¦ Instalar dependÃªncias Node.js
      npm:
        path: "{{ app_dir }}"
        production: false
        
    - name: ğŸ” Verificar TypeScript
      command: npm run type-check
      args:
        chdir: "{{ app_dir }}"
        
    - name: ğŸ—ï¸ Build de produÃ§Ã£o
      command: npm run build:prod
      args:
        chdir: "{{ app_dir }}"
      environment:
        VITE_SUPABASE_URL: "{{ vault_vite_supabase_url }}"
        VITE_SUPABASE_ANON_KEY: "{{ vault_vite_supabase_anon_key }}"
        VITE_N8N_WEBHOOK_URL: "{{ vault_vite_n8n_webhook_url }}"
        VITE_APP_ENV: production
        VITE_DEBUG_MODE: false
        
    - name: ğŸ”§ Configurar Nginx
      template:
        src: nginx-servla.conf
        dest: /etc/nginx/sites-available/{{ app_name }}
        owner: root
        group: root
        mode: '0644'
      notify: restart nginx
        
    - name: ğŸ”— Habilitar site Nginx
      file:
        src: /etc/nginx/sites-available/{{ app_name }}
        dest: /etc/nginx/sites-enabled/{{ app_name }}
        state: link
      notify: restart nginx
        
    - name: ğŸ—‘ï¸ Remover site padrÃ£o Nginx
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: restart nginx
        
    - name: ğŸ“Š Configurar PM2
      template:
        src: ecosystem.config.js
        dest: "{{ app_dir }}/ecosystem.config.js"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0644'
        
    - name: âš¡ Iniciar aplicaÃ§Ã£o com PM2
      command: pm2 start ecosystem.config.js
      args:
        chdir: "{{ app_dir }}"
        
    - name: ğŸ’¾ Salvar configuraÃ§Ã£o PM2
      command: pm2 save
      args:
        chdir: "{{ app_dir }}"
        
    - name: ğŸ”„ Configurar PM2 para iniciar com sistema
      command: pm2 startup
      args:
        chdir: "{{ app_dir }}"
        
    - name: ğŸ“Š Configurar logrotate PM2
      command: pm2 install pm2-logrotate
      args:
        chdir: "{{ app_dir }}"
        
    - name: âš™ï¸ Configurar logrotate
      command: pm2 set pm2-logrotate:max_size 10M
      args:
        chdir: "{{ app_dir }}"
        
    - name: ğŸ”„ Configurar retenÃ§Ã£o de logs
      command: pm2 set pm2-logrotate:retain 7
      args:
        chdir: "{{ app_dir }}"
        
    - name: ğŸ’¾ Salvar configuraÃ§Ãµes PM2
      command: pm2 save
      args:
        chdir: "{{ app_dir }}"
        
    - name: ğŸ“ Criar diretÃ³rio de backup
      file:
        path: /backup/{{ app_name }}
        state: directory
        mode: '0755'
        
    - name: ğŸ”§ Configurar script de backup
      template:
        src: backup-leadflow.sh
        dest: /root/backup-leadflow.sh
        mode: '0755'
        
    - name: â° Configurar cron para backup
      cron:
        name: "Backup LeadFlow"
        hour: "2"
        minute: "0"
        job: "/root/backup-leadflow.sh"
        
    - name: ğŸ”§ Configurar script de monitoramento
      template:
        src: monitor-leadflow.sh
        dest: /root/monitor-leadflow.sh
        mode: '0755'
        
    - name: â° Configurar cron para monitoramento
      cron:
        name: "Monitor LeadFlow"
        minute: "*/5"
        job: "/root/monitor-leadflow.sh"
        
    - name: ğŸ” Verificar status dos serviÃ§os
      service:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - nginx
        
    - name: âœ… Verificar se aplicaÃ§Ã£o estÃ¡ rodando
      uri:
        url: http://localhost/health
        method: GET
      register: health_check
      retries: 3
      delay: 10
      until: health_check.status == 200
        
  handlers:
    - name: restart nginx
      service:
        name: nginx
        state: restarted
















































