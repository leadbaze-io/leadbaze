name: üöÄ Deploy LeadFlow na Servla

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente de deploy'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: üì¶ Install dependencies
      run: npm ci
      
    - name: üîç Type check
      run: npm run type-check
      
    - name: üèóÔ∏è Build application
      run: npm run build:prod
      env:
        VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        VITE_N8N_WEBHOOK_URL: ${{ secrets.VITE_N8N_WEBHOOK_URL }}
        VITE_APP_ENV: production
        VITE_DEBUG_MODE: false
        
    - name: üìÅ Create deployment package
      run: |
        tar -czf leadflow-deploy.tar.gz dist/ deploy-full-servla.sh check-deployment.sh nginx-servla.conf env.example
        
    - name: üöÄ Deploy to Servla
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVLA_HOST }}
        username: ${{ secrets.SERVLA_USERNAME }}
        key: ${{ secrets.SERVLA_SSH_KEY }}
        port: ${{ secrets.SERVLA_PORT }}
        script: |
          # Criar diret√≥rio tempor√°rio
          mkdir -p /tmp/leadflow-deploy
          cd /tmp/leadflow-deploy
          
          # Baixar arquivo de deploy
          wget -O leadflow-deploy.tar.gz ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts
          
          # Extrair arquivos
          tar -xzf leadflow-deploy.tar.gz
          
          # Executar deploy automatizado
          chmod +x deploy-full-servla.sh
          ./deploy-full-servla.sh --auto
          
          # Verificar deploy
          chmod +x check-deployment.sh
          ./check-deployment.sh
          
          # Limpar arquivos tempor√°rios
          cd /
          rm -rf /tmp/leadflow-deploy
          
    - name: ‚úÖ Deploy verification
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVLA_HOST }}
        username: ${{ secrets.SERVLA_USERNAME }}
        key: ${{ secrets.SERVLA_SSH_KEY }}
        port: ${{ secrets.SERVLA_PORT }}
        script: |
          # Verificar se a aplica√ß√£o est√° rodando
          if curl -s http://localhost/health | grep -q "healthy"; then
            echo "‚úÖ Deploy successful!"
            exit 0
          else
            echo "‚ùå Deploy failed!"
            exit 1
          fi
          
    - name: üìß Notify deployment status
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
